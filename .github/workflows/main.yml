name: Build Flet App

on:
  push:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.5'

      - name: Install Flet
        run: |
          pip install flet --upgrade
          pip install flet-cli --upgrade

      - name: Build App
        working-directory: app   # ⚠️ 换成你的 Flutter 项目目录
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            # Android APK
            flutter build apk --release
            # Linux 桌面
            flutter build linux --release
          elif [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            flutter build windows --release
          elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            # iOS IPA
            flutter build ipa --release --no-codesign
            # macOS 桌面 .app
            flutter build macos --release
            # 打包成 DMG
            hdiutil create -volname MyApp \
              -srcfolder build/macos/Build/Products/Release/MyApp.app \
              -ov -format UDZO build/macos/Build/Products/Release/MyApp.dmg
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}
          path: |
            app/build/app/outputs/flutter-apk/app-release.apk
            app/build/linux/x64/release/bundle/*
            app/build/windows/x64/runner/Release/*.exe
            app/build/ios/ipa/*.ipa
            app/build/macos/Build/Products/Release/*.app
            app/build/macos/Build/Products/Release/*.dmg
